---
# yamllint disable rule:colons
#   ___   _   _  _         __      __
#  | _ \ (_) | || |  _  _  \ \    / /
#  |  _/ | | | __ | | || |  \ \/\/ /
#  |_|   |_| |_||_|  \_,_|   \_/\_/
# =============================================================================
# -----------------------------------------------------------------------------
kfg:
  # path to the yaml file defining release history - see semver package
  releases-path: "assets/data/releases.yaml"
clog:
  # legacy - can be deleted
  releases-path: "assets/data/releases.yaml"
#               _                       _
#   ||_  _ _   (_)  _ __   _ __   ___  | |_   ___
#  (_-< | ' \  | | | '_ \ | '_ \ / -_) |  _| (_-<
#  / _/ |_||_| |_| | .__/ | .__/ \___|  \__| /__/
#   ||             |_|    |_|
# -----------------------------------------------------------------------------
snippets:
  # build control logic for this repo - all commands start with bc
  # dev or prod rules:
  #     default - always dev unless build: prod in bc-releases-yaml
  #     rules
  #       - build+deploy- if github_event=="create" then checkout to main
  #       - prod deploy - main branch or empty(default) branch only
  #       - prod deploy - main repo (not fork) only
  #     override
  #       - MAKE prod - forces production (and overrides MAKE dev)
  #       - MAKE dev  - forces development
  # clog bc-prod-logic-xx returns    "dev|prod"+"(reasonString)"
  bc-releases-yaml: yq -r '.clog."releases-path"' clogrc/clog.yaml
  bc-main-repo: echo "metarex-media/www-metarex-media"
  # ---------------------------------------------------------------------------------------------------------
  watch: |
    [ ! -d content ] && ln -s documentation/content content
    hugo server --port=1313 --logLevel debug --buildDrafts --buildFuture --buildExpired --cleanDestinationDir
    rm content
  git:
    tag:
      # pihuw, like Hugo & golang requires a "v"
      ref: echo "v$(yq -r '.[0].version'  "$(clog bc-releases-yaml)")"
      # a go package needs a preceding "v"
      refgo: echo "v$(clog git tag ref)"
    message:
      ref:  yq -r '.[0].note'  assets/data/releases.yaml
    suffix: |
      b="$(git branch --show-current)"
      [[ "$b" == main ]] && echo "" || echo "$b"|tr -d '[:blank:]'"
  project:
    config: |
      PROJECT=pihuw
      DOCKER_NS=mrmxf
    has:
      fomantic: cat layouts/_partials/tmpl/head-cdn|grep -oE '[0-9]+\.[0-9]+\.[0-9]+'|tail -1
      hugo: hugo version|grep -oE '[0-9]\.[0-9]+\.[0-9]+'
      git-lfs: git-lfs version|grep -oE '[0-9]\.[0-9]+\.[0-9]+'|head -1
    needs:
      # grab the golang version from go.mod
      golang: cat go.mod|grep '^go '|grep -oE '[0-9]\.[0-9]+\.[0-9]+'
      # hunt for the hugo version
      hugo: |
        # grab the version from configuration
        if [ -f hugo .yaml ];then
          yq -r '.module.hugoVersion.min' hugo.yaml
        elif [ -f config/_default/module.yaml ];then
          yq -r '.hugoVersion.min' config/_default/module.yaml
        else
          echo "hugo config not found"
        fi
      git-lfs: echo "3.6.0"

# =============================================================================
#    ___   _                 _
#   / __| | |_    ___   __  | |__
#  | (__  | ' \  / -_) / _| | / /
#   \___| |_||_| \___| \__| |_\_\
# -----------------------------------------------------------------------------
check:
  build:
    blocks:
      - name: hugo version
        try: |
          [[ "$(clog project needs hugo)" == "$(clog project has hugo)" ]]
        ok: clog Log -I "hugo $(clog project has hugo) is up to date"
        catch: |
          clog Log -W "hugo: bad version. Need $(clog project needs hugo), got $(clog project has hugo)"
      - name: content folder
        try: "[ ! -d content ]"
        ok: clog Log -I "content folder not linked"
        catch: eval "$(clog Inc)";clog Log -E "content folder exists -$cC ln$cW -d$cF content"
